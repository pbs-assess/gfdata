---
title: "gfdata `get_all' Vignette"
author: "Philina English"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{gfdata Vignette}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, echo = FALSE}
knitr::opts_chunk$set(
  collapse = FALSE,
  comment = "#>",
  cache = TRUE,
  autodep = TRUE,
  fig.path = "get-all-figs/",
  cache.path = "get-all-cache/"
)
```

```{r, echo=FALSE, eval= TRUE}
.error <- tryCatch(get_ssids(), error = function(e) "Error")
.eval <- !identical(class(.error), "character")
```



# Why use a `get_all*` function?

The `get_all*()` functions have been designed to retrieve all fishery-independent data relevant to a particular species, or set of species. 
If `ssid = NULL` they will return all fishery-independent data in the database, including trap (sablefish), longline, jig, and historic trawl surveys.  
If a character string of major stat area codes is provided to the argument `major`, than all sets or samples from that area will be returned. 
If retrieving data for multiple species at once, this function will be a lot faster than the original ones because sql scripts are called once rather than repeatedly for each species. 

## Non-standard data 

The other `get_*()` survey functions focus on retrieving sets and samples that conform to current design-based standards and survey grids. 
This means that they do not retrieve sets and samples from cells that fall within Rockfish Conservation Areas, or that have otherwise been excluded from the latest version of the survey grid. 
<!-- Their default settings also exclude tows that are shorter than the standard length.  -->

They also were not built to retrieve data that differed at the skate level (like gear comparison studies), which this function will return only when gear variables (currently checking for differences in hook code and size) differ between skates. 


## Duplication of fishing events and specimens

One risk in using these functions is that some fishing events and specimen ids may be duplicated in the resulting data set. This occurs because some vessel trips conduct sampling for multiple survey series, and unless joining is based on grouping codes (which aren't used consistently for some surveys ) the only way to connect a fishing event to a survey series is through the vessel trip. This can result in events and specimens getting assigned to both surveys that were conducted on the same trip. The most common instances of this have custom corrections coded into an internal function `correct_ssids()` that is applied automatically by the `get_all*` functions. Other ways duplication occurs can be due to missing covariates (e.g., both event level and survey defaults are missing for `doorspread_m` on a couple sets for some trawl series), or when multiple vials of DNA were collected and `return_dna_info = TRUE`. 


# Examples

If you don't already have the package installed, see the general gfdata vignette for instructions.
Here we will load the package along with dplyr.

```{r, cache=FALSE, warning = FALSE, message = FALSE}
library(gfdata)
library(dplyr)
```

The available arguments are described in the help documentation:

```{r, eval = FALSE}
?get_all_survey_sets
?get_all_survey_samples
```

 
## What data is available for a species?

As an example, we might want to determine what survey set data exists for Bluntnose Sixgill Sharks (*Hexanchus griseus*) in our database. For now, we will leave the default settings that pull all surveys and all areas. It should be noted that some data from United States waters is in our data base, so if we are only interested in Canadian records those sets would need to be filtered. It's not the default for this function, but we'll start by using `remove_false_zeros = FALSE` because the values returned will then match `get_survey_sets()` for any events returned by both functions. 

```{r, eval=.eval, warning=TRUE, cache=TRUE}
d0 <- get_all_survey_sets("Bluntnose Sixgill Shark", remove_false_zeros = FALSE)
head(d0)
```
Notice that `catch_weight` sometimes contains zeros when `catch_count` is at least 1. This may be because some specimens may be too large for the scale and null values are assumed by our SQL calls to be zeros. To avoid this, use the argument `remove_false_zeros = TRUE`. 

```{r, eval=.eval, warning=TRUE, cache=TRUE}
d <- get_all_survey_sets("Bluntnose Sixgill Shark", remove_false_zeros = TRUE)
glimpse(d)
```

In the console, you will also see: 

> Warning messages:
>1: In get_all_survey_sets(species = spp, ssid = ssid, major = major_areas,  :
>  Returning all survey series that recorded any Bluntnose Sixgill Shark.
>2: In get_all_survey_sets(species = spp, ssid = ssid, major = major_areas,  :
>  Duplicate fishing_event_ids are still present despite `remove_duplicates = TRUE`. This may be because of overlapping survey stratifications or multiple skates per event (specifically when at least one survey included used skates with differences in gear type), but could also be due to trips participating in more than one type of survey. If the latter, gear or reason covariates should be used to choose which even to keep. After selecting specific survey stratifications and determining that all relevant variables are accurate, the remaining duplications can be filtered using `dat <- dat[!duplicated(dat$fishing_event_id), ]`. 

Which surveys encountered Bluntnose Sixgill Sharks?

```{r, eval=.eval, warning=TRUE, cache=TRUE}
d |> group_by(survey_series_id, survey_series_desc) |> 
  summarise(rows = n(),
            events = length(unique(fishing_event_id)),
            individuals = sum(catch_count)) |>
  arrange(individuals)
```




As an example, we might want to determine what survey sample data exists for Pacific Spiny Dogfish in the Strait of Georgia.

```{r, eval=.eval}
dat <- get_all_survey_samples("north pacific spiny dogfish")
head(dat)
```

<!-- Note that there are some duplicate records in the databases due to relating a  -->
<!-- record to multiple stratification schemes for alternative analyses. If this  -->
<!-- occurs, a warning is given. -->

<!-- > "Duplicate specimen IDs are present because of overlapping survey stratifications. If working with the data yourelf, filter them after selecting specific surveys. For example, `dat <- dat[!duplicated(dat$specimen_id), ]`. The tidying and plotting functions within gfplot will do this for you." -->


<!-- We can further restrict the data extraction to a single trawl survey series  -->
<!-- by including the ssid (survey series id) argument. For a list of -->
<!-- survey series id codes, run the lookup function `get_ssids()`. -->

<!-- ```{r, eval=.eval} -->
<!-- ssids <- get_ssids() -->
<!-- head(ssids) -->
<!-- ``` -->

<!-- Select desired ssid and include as argument (i.e. the Queen Charlotte -->
<!-- Sound bottom trawl survey): -->

<!-- ```{r, eval = FALSE} -->
<!-- dat <- get_survey_samples(222, ssid = 1) -->
<!-- head(dat) -->
<!-- ``` -->

<!-- ```{r, echo = FALSE, eval=.eval} -->
<!-- dat <- dat %>% filter(survey_series_id == 1) -->
<!-- ``` -->

<!-- ```{r, eval=.eval} -->
<!-- glimpse(dat) -->
<!-- ``` -->

