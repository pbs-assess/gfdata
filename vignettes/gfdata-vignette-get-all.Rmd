---
title: "gfdata `get_all` vignette"
author: "Philina English"
date: "2024-10-11"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{gfdata `get_all' Vignette}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---



## Why use a `get_all_*()` function?

The original `get_*()` survey functions are limited to returning sets and specimen samples that conform to current survey design specifications based on assigned grouping and usability codes.
This works well for some surveys and data uses that depend on sampling a consistent survey footprint across years such as generating design-based abundance indexes.
Other uses can harness information from samples that were collected outside the current survey footprint or from different types of surveys, some of which don't consistently apply these codes.
The `get_all_*()` functions have been designed to retrieve all fishery-independent survey data relevant to a particular species, or set of species, and to do so more quickly and comprehensively than the original functions.
When retrieving data for multiple species at once, these functions will be dramatically faster than the original `get_*()` functions.
This is because sql scripts are called once for all species rather than repeatedly for each species.
When retrieving data for single species run times will depend on which surveys and arguments are used.
The extent of the data returned can be specific to a single survey, a single major stat area, any combination of these, or generalized to get everything in the database that is appropriately formatted.
<!-- Currently, Nearshore Shrimp trawl and IPES survey data are not available.  -->
Additional variables are also returned to support modelling objectives and decisions regarding which data should be retained for specific purposes.

### More flexibility

The original functions required the user to specify survey series ids (`ssid`) and were limited in which they could accept and return.
<!-- They were primarily designed to pull the contemporary synoptic trawl surveys (`ssid = c(1, 3, 4, 16)`), the historic Hecate Strait Multispecies Assemblage trawl survey (`ssid = c(2)`), IPHC (`ssid = c(14)`), and four Hard Bottom Longline surveys (`ssid = c(22, 36, 39, 40)`). -->
For `get_all_*()` functions, we have the option to set `ssid = NULL` which will return all fishery-independent samples and catch data in the database, as long as the survey series ids (and for catch data, survey ids as well) have been assigned in the database.
These include trap (sablefish), longline, jig, and most contemporary and historic trawl surveys (exceptions include the Nearshore Shrimp trawl survey for which survey ids are missing).
If a character string of major stat area codes is provided to the argument `major`, than all sets or samples from that area will be returned.


### Design-based analyses

Because the original `get_*()` survey functions were intended to only return sets and specimen samples that conform to current survey design specifications, they cannot retrieve sets and samples from cells that fall outside the latest definition of a particular survey's design.
When this behaviour is desired, it can be reproduced using the `get_all_*()` functions with the filtering options `usability = c(0, 1, 2, 6)` and `grouping_only = TRUE`.
This works reliably for most groundfish bottom trawl and longline surveys (`ssid = c(1, 2, 3, 4, 16, 22, 36, 39, 40)`).
However, when these filtering options are applied to certain surveys, a small proportion of the data returned by the original function may be missed (e.g., IPHC: `ssid = 14`) and no data is returned for surveys for which grouping or usability codes do not appear in the database (e.g., the jig survey: `ssid = c(82:87)`).

If using the `get_all_*()` functions to generate design-based indices, the strata area variable is now called `grouping_area_km2` (instead of `area_km2` to avoid confusion with `area_swept*` variables) and, in case design changes occur that are not incorporated into the usability codes, one should also always check for differences between the `grouping_code` and `grouping_code_updated` variables.
The `grouping_code_updated` generally contains a subset of the former, likely as a result of a shrinking footprint or the dropping an entire strata from a survey's definition.
This is currently the case for the offshore shrimp, also known as multi-species small-mesh (MSSM), surveys (`ssid = c(6, 7)`), which needs to be filtered for only those sets with updated grouping codes (`!is.na(grouping_code_updated)`) in order to match the current survey design.
Consulting data stewards for specific surveys may be helpful in understanding differences between grouping codes.

To retrieve specimen samples that conform to design specifications, the arguments `unsorted_only = TRUE` and `random_only = TRUE` should be used in addition to usability and grouping options.
When doing so `get_all_survey_samples()` function will return > 70 additional specimens over the original function for each of the longline surveys (`ssid = c(22, 36, 39, 40)`).
This is because the original `get_survey_samples()` function used a stricter method for filtering based on grouping codes.
This stricter filtering matches how `get_survey_sets()` filtered for the current trawl survey footprint, but not how it filtered sets for longline surveys.
If desired, this stricter filtering can be achieved for both sets and samples from any survey by filtering for `!is.na(grouping_code_updated)`.


### Non-standard data

<!-- Their default settings also exclude tows that are shorter than the standard length.  -->
In contrast, the default behaviour of the `get_all_*()` survey functions is to return all data collected on any given survey, whether or not it conforms to current design.
This includes sets and samples from grid cells that all within subsequently established Rockfish Conservation areas (RCAs), and data that differ at the skate level.
The original functions were not built to retrieve data that differed at the skate level, like gear comparison studies (e.g., `ssid = 48`).
The `get_all_*()` functions will automatically return catch information at the skate level, instead of the fishing event level, for sets within a single function call whenever gear variables (currently checking for differences in hook code and size) differ between skates.


 

## Set up

If you don't already have the package installed, see the general gfdata vignette for instructions.
Here we will load gfdata along with the package dplyr.

 
 ``` r
 library(gfdata)
 library(dplyr)
 library(tibble)
 ```

 

The available arguments are described in the help documentation:

 
 ``` r
 ?get_all_survey_sets()
 ?get_all_survey_samples()
 ```


## Examples

### What survey data is available for a species?

As an example, we might want to determine what survey set data are in our database for Bluntnose Sixgill Sharks (*Hexanchus griseus*).
For now, we will leave the default settings that pull all surveys and all areas.
Beware that some records in the database are from outside Canadian waters.
If desired, returned data can be filtered using the `major_stat_area_code` to retain only Canadian records (see `get_major_areas()` to identify which codes to use).

#### Original `get_survey_sets()` function

To start with, we check what the original `get_survey_sets()` function returns for this species.
By default this function returns just the most commonly used groundfish surveys: synoptic trawl (`ssid = c(1, 3, 4, 16)`), one historical trawl (`2`), and five longline--IPHC (`14`) and PHMA (`22, 36, 39, 40`) surveys.
The first thing to note here is that this function will only return one row per fishing event (unless overlapping survey series or sample_ids were requested).
This function will also return all sets for any survey series, even when the species has never been recorded on that survey.



































